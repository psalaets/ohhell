/*! Oh Hell Scorekeeper - v0.8.0 - 2013-07-04
* Copyright (c) 2013 Paul Salaets; Licensed MIT */
(function(e){function t(e){this.player=e,this.bid=0,this.gotBid=null}function n(e,t,n,r){this.id=e,this.name=t,this.maxTricks=n,this.dealer=r}function r(){this.players=[],this.rounds=[],this.startTime=Date.now()}function i(e,t){function i(){return r+=1,r}var n=e.players.slice(0);n.rotate=function(){return this.rotate=function(){return this.push(this.shift()),this.slice(0)},this};var r=0;e.rounds=[].concat(s(i,t,n),o(i,t,n),u(i,t,n))}function s(e,t,r){var i=[];for(var s=1;s<t;s++)i.push(n.create(e(),s.toString(),s,r.rotate()));return i}function o(e,t,r){return n.create(e(),t.toString(),t,r.rotate())}function u(e,t,r){var i=[];for(var s=t-1;s>0;s--)i.push(n.create(e(),s.toString(),s,r.rotate()));return i}e.module("ohhell.model",[]).constant("RoundScore",t).constant("Round",n).constant("Game",r),t.fromJson=function(e){var n=new t(e.player);return n.bid=e.bid,n.gotBid=e.gotBid,n},t.prototype={getPlayer:function(){return this.player},setBid:function(e){this.bid=e},getBid:function(){return this.bid},madeBid:function(){this.gotBid=!0},missedBid:function(){this.gotBid=!1},getPoints:function(){return this.isReported()?(10+this.bid)*(this.gotBid?1:-1):null},isReported:function(){return this.gotBid!==null},toJson:function(){return{bid:this.bid,gotBid:this.gotBid,player:this.player}}},n.create=function(e,r,i,s){var o=new n(e,r,i,s[0]);return o.scores=s.map(function(e){return new t(e)}),o},n.fromJson=function(e){var r=new n(e.id,e.name,e.maxTricks,e.dealer);return r.scores=e.scores.map(function(e){return t.fromJson(e)}),r},n.prototype={getId:function(){return this.id},getName:function(){return this.name},getMaxTricks:function(){return this.maxTricks},getDealer:function(){return this.dealer},getScores:function(){return this.scores},getScore:function(e){return this.scores.filter(function(t){return t.getPlayer()===e})[0]||null},isFinished:function(){return this.scores.every(function(e){return e.isReported()})},getTotalBids:function(){return this.scores.reduce(function(e,t){return e+t.getBid()},0)},allScoresMadeBid:function(){this.scores.forEach(function(e){e.madeBid()})},toJson:function(){return{id:this.id,name:this.name,maxTricks:this.maxTricks,dealer:this.dealer,scores:this.scores.map(function(e){return e.toJson()})}}},r.create=function(e,t){var n=new r;return n.players=e,i(n,t),n},r.fromJson=function(e){var t=new r;return t.startTime=e.startTime,t.players=e.players,t.rounds=e.rounds.map(function(e){return n.fromJson(e)}),t},r.prototype={getPlayers:function(){return this.players},getRounds:function(){return this.rounds},getRound:function(e){return this.rounds.filter(function(t){return t.getId()===e})[0]||null},getCurrentRound:function(){return this.rounds.filter(function(e){return!e.isFinished()})[0]||null},isFinished:function(){return this.rounds.every(function(e){return e.isFinished()})},getScores:function(e){return this.rounds.map(function(t){return t.getScore(e)})},toJson:function(){return{players:this.players,rounds:this.rounds.map(function(e){return e.toJson()}),startTime:this.startTime}},roundsLeft:function(){return this.rounds.filter(function(e){return!e.isFinished()}).length}}})(angular),angular.module("ohhell.directive",[]).directive("ohhellTrend",function(){return{restrict:"A",scope:{playerScores:"=",minScore:"@",maxScore:"@"},link:function(e,t,n){function r(){return e.minScore!==undefined&&e.maxScore!==undefined&&e.playerScores!==undefined}e.$watch(function(){return r()},function(n){n&&$(t).sparkline(e.playerScores,{fillColor:!1,maxSpotColor:!1,minSpotColor:!1,chartRangeMin:e.minScore,chartRangeMax:e.maxScore})})}}}),angular.module("ohhell.controller",[]).controller("LandingController",["$scope","navService","storageService",function(e,t,n){e.savedGameCount=n.all().length,e.setup=function(){t.newGame()},e.showSavedGames=function(){t.savedGames()}}]).controller("SetupController",["$scope","navService","Game","storageService",function(e,t,n,r){e.maxRound=8,e.maxRoundAllowed=8,e.players=[],e.addPlayer=function(t){t&&(e.players.push(t),e.playerName="")},e.removePlayerAtPosition=function(t){e.players.splice(t,1)},e.$watch("players.length",function(e,t,n){e<2?(n.message="Need at least two players to begin",n.needMorePlayers=!0):(n.message="",n.needMorePlayers=!1)}),e.startGame=function(){var i=n.create(e.players,e.maxRound);r.save(i),t.currentRound(i)}}]).controller("SavedGamesController",["$scope","navService","storageService",function(e,t,n){e.savedGames=n.all(),e.resume=function(e){e.roundsLeft()?t.currentRound(e):t.scoreboard(e)}}]).controller("RoundController",["$scope","$routeParams","navService","storageService",function(e,t,n,r){var i=t.round,s=t.gameTimestamp,o=r.find(s);e.round=o.getRound(parseInt(i,10)),e.roundFinished=function(){r.save(o),n.scoreboard(o)},e.everyoneGotIt=function(){e.round.allScoresMadeBid()}}]).controller("ScoreboardController",["$scope","$routeParams","navService","summaryService","storageService",function(e,t,n,r,i){var s=t.gameTimestamp,o=i.find(s);e.rounds=o.getRounds(),e.stats=r.generateStats(o),e.hasNextRound=function(){return o.roundsLeft()},e.nextRound=function(){n.currentRound(o)},e.done=function(){i.remove(o),n.landingPage()}}]),angular.module("ohhell.service",["ohhell.model"]).factory("storageService",["Game",function(e){function n(){return t.get("games")}function r(e){return t.set("games",e)}var t=storage;return r(n()||{}),{all:function(){var t=n(),r=[];for(var i in t)r.push(t[i]);return r.map(function(t){return e.fromJson(t)})},save:function(e){var t=n();t[e.startTime]=e.toJson(),r(t)},remove:function(e){var t=n();delete t[e.startTime],r(t)},find:function(t){var r=n(),i=r[t];return i&&e.fromJson(i)}}}]).factory("navService",["$location",function(e){function n(){var e=Array.prototype.slice.call(arguments,0);return t+e.join("/")}var t="/";return{landingPage:function(){e.path(t)},newGame:function(){e.path(n("new"))},savedGames:function(){e.path(n("games"))},scoreboard:function(t){e.path(n("games",t.startTime))},currentRound:function(e){var t=e.getCurrentRound();this.round(e,t.getId())},round:function(t,r){e.path(n("games",t.startTime,"rounds",r))}}}]).factory("summaryService",function(){return{generateStats:function(e){var t=this,n=e.getPlayers().map(function(n){return t.generateStat(n,e)});return this.rank(n),this.minAndMaxRoundScore(n),n},generateStat:function(e,t){var n={player:e,scores:t.getScores(e)};return this.total(n),this.streak(n),this.totalScoresPerRound(n),n},minAndMaxRoundScore:function(e){var t=0,n=0;e.forEach(function(e){t=Math.min(t,Math.min.apply(Math,e.totalScoresPerRound)),n=Math.max(n,Math.max.apply(Math,e.totalScoresPerRound))}),e.minScore=t,e.maxScore=n},rank:function(e){e.sort(function(e,t){return t.total-e.total}),e.forEach(function(e,t,n){var r=n[t-1];r&&r.total===e.total?e.rank=r.rank:e.rank=t+1})},total:function(e){e.total=e.scores.reduce(function(e,t){return t.isReported()?e+t.getPoints():e},0)},streak:function(e){var t=[];e.scores.forEach(function(e){e.isReported()&&t.push(e.gotBid)}),t.reverse();var n=null,r=0;for(var i=0;i<t.length;i++)if(n===null)n=t[i],r++;else{if(n!==t[i])break;r++}e.streak=(n?"Got ":"Missed ")+r},totalScoresPerRound:function(e){var t=e.scores.filter(function(e){return e.isReported()}),n=[],r=0;t.forEach(function(e){r+=e.getPoints(),n.push(r)}),n.unshift(0),e.totalScoresPerRound=n}}}),angular.module("ohhell.filter",[]).filter("sign",function(){return function(e){if(angular.isNumber(e)){if(e>0)return"+"+e;if(e<0)return e.toString()}}}).filter("upto",function(){return function(e,t){var n=[];for(var r=e;r<=t;r++)n.push(r);return n}}).filter("place",function(){var e={1:"st",2:"nd",3:"rd",11:"th",12:"th",13:"th"};return function(t){return t+(e[t]||"th")}}).filter("sentence",function(){return function(e){if(e.length===1)return e[0];if(e.length===2)return e[0]+" and "+e[1];if(e.length>2){var t=e.slice(0),n=t.pop();return t.join(", ")+" and "+n.toString()}}}).filter("timeAgo",function(){var e=vagueTime;return function(t){return e.get({from:t,units:"ms"})}}).filter("withTotalRounds",function(){return function(e){var t=e*2-1,n=t===1?"1 round":t+" total rounds";return e+" ("+n+")"}}),angular.module("ohhell",["ohhell.directive","ohhell.service","ohhell.filter","ohhell.controller"]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"landing.html",controller:"LandingController"}).when("/new",{templateUrl:"setup.html",controller:"SetupController"}).when("/games/:gameTimestamp/rounds/:round",{templateUrl:"round.html",controller:"RoundController"}).when("/games/:gameTimestamp",{templateUrl:"scoreboard.html",controller:"ScoreboardController"}).when("/games",{templateUrl:"savedGames.html",controller:"SavedGamesController"}).otherwise({redirectTo:"/"})}]);