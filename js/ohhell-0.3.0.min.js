/*! Oh Hell Scorekeeper - v0.3.0 - 2012-10-13
* Copyright (c) 2012 Paul Salaets; Licensed MIT */
(function(e){function t(e){this.player=e,this.bid=0,this.gotBid=null}function n(e,n,r,i){this.id=e,this.name=n,this.maxTricks=r,this.dealer=i.slice(-1)[0],this.scores=i.map(function(e){return new t(e)})}function r(e,t){this.players=e,this.rounds=[],this.createRounds(t)}e.module("ohhell.model",[]).constant("RoundScore",t).constant("Round",n).constant("Game",r),t.prototype={getPlayer:function(){return this.player},setBid:function(e){this.bid=e},getBid:function(){return this.bid},madeBid:function(){this.gotBid=!0},missedBid:function(){this.gotBid=!1},getPoints:function(){return this.isReported()?(10+this.bid)*(this.gotBid?1:-1):null},isReported:function(){return this.gotBid!==null}},n.prototype={getId:function(){return this.id},getName:function(){return this.name},getMaxTricks:function(){return this.maxTricks},getDealer:function(){return this.dealer},getScores:function(){return this.scores},getScore:function(e){return this.scores.filter(function(t){return t.getPlayer()===e})[0]||null},isFinished:function(){return this.scores.every(function(e){return e.isReported()})},getTotalBids:function(){return this.scores.reduce(function(e,t){return e+t.getBid()},0)},allScoresMadeBid:function(){this.scores.forEach(function(e){e.madeBid()})}},r.prototype={createRounds:function(e){var t=this.players.slice(0);t.rotate=function(){return this.push(this.shift()),this.slice(0)},this.createAscendingRounds(e,t),this.createHighRound(e,t),this.createDescendingRounds(e,t)},createAscendingRounds:function(e,t){for(var r=1;r<e;r++)this.rounds.push(new n(this.rounds.length+1,r.toString(),r,t.rotate()))},createHighRound:function(e,t){this.rounds.push(new n(this.rounds.length+1,e.toString(),e,t.rotate()))},createDescendingRounds:function(e,t){for(var r=e-1;r>0;r--)this.rounds.push(new n(this.rounds.length+1,r.toString(),r,t.rotate()))},getPlayers:function(){return this.players},getRounds:function(){return this.rounds},getRound:function(e){return this.rounds.filter(function(t){return t.getId()===e})[0]||null},getCurrentRound:function(){return this.rounds.filter(function(e){return!e.isFinished()})[0]||null},isFinished:function(){return this.rounds.every(function(e){return e.isFinished()})},getScores:function(e){return this.rounds.map(function(t){return t.getScore(e)})}}})(angular),angular.module("ohhell.controller",[]).controller("LandingController",["$scope","$location",function(e,t){e.setup=function(){t.path("/ohhell/setup")}}]).controller("SetupController",["$scope","$location","gameService",function(e,t,n){e.maxRound=8,e.maxRoundAllowed=8,e.players=[],e.$watch("players.length",function(e,t,n){e<2?(n.message="Need at least two players to begin",n.needMorePlayers=!0):(n.message="",n.needMorePlayers=!1)}),e.startGame=function(){n.startNewGame(e.players,e.maxRound),t.path("/ohhell/round/1")}}]).controller("RoundController",["$scope","$routeParams","$location","gameService",function(e,t,n,r){var i=t.round;e.round=r.currentGame.getRound(parseInt(i,10)),e.roundFinished=function(){n.path("/ohhell/scoreboard")},e.everyoneGotIt=function(){e.round.allScoresMadeBid()}}]).controller("ScoreboardController",["$scope","$location","gameService","summaryService",function(e,t,n,r){var i=n.currentGame;e.rounds=i.getRounds(),e.stats=r.generateStats(i),e.hasNextRound=function(){return!!i.getCurrentRound()},e.nextRound=function(){var e=i.getCurrentRound();t.path("/ohhell/round/"+e.getId())}}]),angular.module("ohhell.service",["ohhell.model"]).factory("gameService",["Game",function(e){return{currentGame:null,startNewGame:function(t,n){this.currentGame=new e(t,n)}}}]).factory("summaryService",function(){return{generateStats:function(e){var t=this,n=e.getPlayers().map(function(n){return t.generateStat(n,e)});return this.rank(n),n},generateStat:function(e,t){var n={player:e,scores:t.getScores(e)};return this.total(n),this.streak(n),n},rank:function(e){e.sort(function(e,t){return t.total-e.total}),e.forEach(function(e,t,n){var r=n[t-1];r&&r.total===e.total?e.rank=r.rank:e.rank=t+1})},total:function(e){e.total=e.scores.reduce(function(e,t){return t.isReported()?e+t.getPoints():e},0)},streak:function(e){var t=[];e.scores.forEach(function(e){e.isReported()&&t.push(e.gotBid)}),t.reverse();var n=null,r=0;for(var i=0;i<t.length;i++)if(n===null)n=t[i],r++;else{if(n!==t[i])break;r++}e.streak=(n?"Got ":"Missed ")+r}}}),angular.module("ohhell.filter",[]).filter("sign",function(){return function(e){if(angular.isNumber(e)){if(e>0)return"+"+e;if(e<0)return e.toString()}}}).filter("upto",function(){return function(e,t){var n=[];for(var r=e;r<=t;r++)n.push(r);return n}}).filter("place",function(){var e={1:"st",2:"nd",3:"rd"};return function(t){return t+(e[t]||"th")}}),angular.module("ohhell",["ohhell.service","ohhell.filter","ohhell.controller"]).config(["$routeProvider",function(e){e.when("/ohhell",{templateUrl:"landing.html",controller:"LandingController"}).when("/ohhell/setup",{templateUrl:"setup.html",controller:"SetupController"}).when("/ohhell/round/:round",{templateUrl:"round.html",controller:"RoundController"}).when("/ohhell/scoreboard",{templateUrl:"scoreboard.html",controller:"ScoreboardController"}).otherwise({redirectTo:"/ohhell"})}]);